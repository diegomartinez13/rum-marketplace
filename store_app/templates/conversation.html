{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 100%; padding-left: 15px; padding-right: 15px;">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="bi bi-chat me-2"></i>Conversation with
          {% if other_participant %}
          {{ other_participant.get_full_name|default:other_participant.username }}
          {% else %}
          {% for message in messages %}
          {% if message.sender != request.user %}
          {{ message.sender.get_full_name|default:message.sender.username }}
          {% endif %}
          {% empty %}
          Unknown User
          {% endfor %}
          {% endif %}
        </h2>
        <a href="{% url 'store_app:messages' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back to Messages
        </a>
      </div>

      {% if conversation.product or conversation.service %}
      <div class="alert alert-info mb-4">
        <i class="bi bi-tag me-2"></i>
        <strong>About:</strong>
        {% if conversation.product %}
        <a href="{% url 'store_app:product_detail' conversation.product.id %}" class="text-decoration-none">{{ conversation.product.name }}</a>
        {% elif conversation.service %}
        <a href="#" class="text-decoration-none">{{ conversation.service.name }}</a>
        {% endif %}
      </div>
      {% endif %}

      <!-- Messages Container -->
      <div class="card shadow-sm mb-4" style="position: relative;">
        <div class="card-body" id="messagesContainer" style="height: 500px; overflow-y: auto;">
          {% if messages %}
          {% for message in messages %}
          <div
            class="d-flex mb-3 {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}"
            data-message-id="{{ message.id }}">
            {% if message.sender != request.user %}
            <div class="me-2">
              {% if message.sender.profile.profile_picture %}
              <img src="/media/{{ message.sender.profile.profile_picture }}" 
                class="rounded-circle" 
                alt="Profile Picture" 
                width="40" 
                height="40" 
                style="object-fit: cover;">
              {% else %}
              <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px;">
                <i class="bi bi-person-fill text-white"></i>
              </div>
              {% endif %}
            </div>
            {% endif %}
            <div
              class="{% if message.sender == request.user %}bg-primary text-white{% else %}bg-light text-dark{% endif %} rounded p-3"
              style="max-width: 70%; word-wrap: break-word; overflow-wrap: break-word;">
              <div class="d-flex align-items-center mb-1">
                <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %}">
                  {{ message.sender.get_full_name|default:message.sender.username }}
                </small>
                <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %} ms-2">
                  {{ message.created_at|date:"M j, Y g:i A" }}
                </small>
              </div>
              {% if message.product or message.service %}
              <div class="mb-2">
                <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %}">
                  <i class="bi bi-tag me-1"></i>
                  <strong>About:</strong>
                  {% if message.product %}
                  <a href="{% url 'store_app:product_detail' message.product.id %}" class="{% if message.sender == request.user %}text-white-50{% else %}text-decoration-none text-primary{% endif %}">
                    {{ message.product.name }}
                  </a>
                  {% elif message.service %}
                  {{ message.service.name }}
                  {% endif %}
                </small>
              </div>
              {% endif %}
              <p class="mb-0">{{ message.content }}</p>
            </div>
            {% if message.sender == request.user %}
            <div class="ms-2">
              {% if request.user.profile.profile_picture %}
              <img src="/media/{{ request.user.profile.profile_picture }}" 
                class="rounded-circle" 
                alt="Profile Picture" 
                width="40" 
                height="40" 
                style="object-fit: cover;">
              {% else %}
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 40px; height: 40px;">
                <i class="bi bi-person-fill text-white"></i>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
          {% else %}
          <div id="noMessagesPlaceholder" class="text-center text-muted py-5">
            <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
            <p class="mt-3">No messages yet. Start the conversation!</p>
          </div>
          {% endif %}
        </div>

        <!-- Scroll to Bottom Button -->
        <button id="scrollToBottomBtn" class="btn btn-primary rounded-circle shadow"
          style="position: absolute; bottom: 15px; right: 15px; width: 45px; height: 45px; z-index: 10; display: flex; align-items: center; justify-content: center; border: none;">
          <i class="bi bi-arrow-down" style="font-size: 1.2rem;"></i>
        </button>
      </div>

      <!-- Message Form -->
      <div class="card">
        <div class="card-body">
          <form id="messageForm" method="post">
            {% csrf_token %}
            {% if other_products or other_services %}
            <div class="mb-3">
              <label for="productServiceSelect" class="form-label small text-muted">
                <i class="bi bi-tag me-1"></i>Select product/service (optional):
              </label>
              <select id="productServiceSelect" class="form-select form-select-sm">
                <option value="">-- General conversation --</option>
                {% if other_products %}
                <optgroup label="Products">
                  {% for product in other_products %}
                  <option value="product_{{ product.id }}">
                    {{ product.name }}{% if product.user_vendor == request.user %} (Yours){% endif %}
                  </option>
                  {% endfor %}
                </optgroup>
                {% endif %}
                {% if other_services %}
                <optgroup label="Services">
                  {% for service in other_services %}
                  <option value="service_{{ service.id }}">
                    {{ service.name }}{% if service.user_provider == request.user %} (Yours){% endif %}
                  </option>
                  {% endfor %}
                </optgroup>
                {% endif %}
              </select>
            </div>
            {% endif %}
            <div class="input-group">
              <textarea name="content" id="messageContent" class="form-control" placeholder="Type your message..."
                rows="2" required style="resize: none;"></textarea>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send me-1"></i>Send
              </button>
            </div>
            <input type="hidden" name="product_id" id="productIdInput" value="">
            <input type="hidden" name="service_id" id="serviceIdInput" value="">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card-body::-webkit-scrollbar {
    width: 6px;
  }

  .card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .card-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }

  .card-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  #scrollToBottomBtn {
    transition: all 0.3s ease;
    cursor: pointer;
  }

  #scrollToBottomBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  #scrollToBottomBtn:active {
    transform: scale(0.95);
  }
</style>

<script>
  // Auto-scroll to bottom of messages
  function scrollToBottom() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
      // Force scroll to the very bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      console.log('Scrolling to bottom. ScrollTop:', messagesContainer.scrollTop, 'ScrollHeight:', messagesContainer.scrollHeight);
    }
  }

  // Add new message to the conversation
  function addMessageToConversation(messageData) {
    const messagesContainer = document.getElementById('messagesContainer');
    const isCurrentUser = messageData.sender === '{{ request.user.username }}';
    
    // Remove the "No messages yet" placeholder if it exists
    const placeholder = document.getElementById('noMessagesPlaceholder');
    if (placeholder) {
      placeholder.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `d-flex mb-3 ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}`;
    if (messageData.id) {
      messageDiv.setAttribute('data-message-id', messageData.id);
    }

    // Add profile picture for other user (before message bubble)
    if (!isCurrentUser) {
      const profilePicDiv = document.createElement('div');
      profilePicDiv.className = 'me-2';
      
      if (messageData.sender_profile_picture) {
        const profileImg = document.createElement('img');
        profileImg.src = `/media/${messageData.sender_profile_picture}`;
        profileImg.className = 'rounded-circle';
        profileImg.alt = 'Profile Picture';
        profileImg.width = 40;
        profileImg.height = 40;
        profileImg.style.objectFit = 'cover';
        profilePicDiv.appendChild(profileImg);
      } else {
        const defaultPic = document.createElement('div');
        defaultPic.className = 'bg-secondary rounded-circle d-flex align-items-center justify-content-center';
        defaultPic.style.width = '40px';
        defaultPic.style.height = '40px';
        const icon = document.createElement('i');
        icon.className = 'bi bi-person-fill text-white';
        defaultPic.appendChild(icon);
        profilePicDiv.appendChild(defaultPic);
      }
      messageDiv.appendChild(profilePicDiv);
    }

    const messageBubble = document.createElement('div');
    messageBubble.className = `${isCurrentUser ? 'bg-primary text-white' : 'bg-light text-dark'} rounded p-3`;
    messageBubble.style.maxWidth = '70%';
    messageBubble.style.wordWrap = 'break-word';
    messageBubble.style.overflowWrap = 'break-word';

    const messageHeader = document.createElement('div');
    messageHeader.className = 'd-flex align-items-center mb-1';

    const senderName = document.createElement('small');
    senderName.className = isCurrentUser ? 'text-white-50' : 'text-muted';
    senderName.textContent = messageData.sender_name;

    const timestamp = document.createElement('small');
    timestamp.className = `${isCurrentUser ? 'text-white-50' : 'text-muted'} ms-2`;
    timestamp.textContent = messageData.timestamp;

    messageHeader.appendChild(senderName);
    messageHeader.appendChild(timestamp);
    messageBubble.appendChild(messageHeader);

    // Add product/service context if present
    if (messageData.product || messageData.service) {
      const contextDiv = document.createElement('div');
      contextDiv.className = 'mb-2';
      
      const contextText = document.createElement('small');
      contextText.className = isCurrentUser ? 'text-white-50' : 'text-muted';
      
      const icon = document.createElement('i');
      icon.className = 'bi bi-tag me-1';
      contextText.appendChild(icon);
      
      const strong = document.createElement('strong');
      strong.textContent = 'About: ';
      contextText.appendChild(strong);
      
      if (messageData.product) {
        const link = document.createElement('a');
        link.href = `/product/${messageData.product.id}/`;
        link.className = isCurrentUser ? 'text-white-50' : 'text-decoration-none text-primary';
        link.textContent = messageData.product.name;
        contextText.appendChild(link);
      } else if (messageData.service) {
        contextText.appendChild(document.createTextNode(messageData.service.name));
      }
      
      contextDiv.appendChild(contextText);
      messageBubble.appendChild(contextDiv);
    }

    const messageContent = document.createElement('p');
    messageContent.className = 'mb-0';
    messageContent.textContent = messageData.content;

    messageBubble.appendChild(messageContent);
    messageDiv.appendChild(messageBubble);

    // Add profile picture for current user (after message bubble)
    if (isCurrentUser) {
      const profilePicDiv = document.createElement('div');
      profilePicDiv.className = 'ms-2';
      
      if (messageData.current_user_profile_picture) {
        const profileImg = document.createElement('img');
        profileImg.src = `/media/${messageData.current_user_profile_picture}`;
        profileImg.className = 'rounded-circle';
        profileImg.alt = 'Profile Picture';
        profileImg.width = 40;
        profileImg.height = 40;
        profileImg.style.objectFit = 'cover';
        profilePicDiv.appendChild(profileImg);
      } else {
        const defaultPic = document.createElement('div');
        defaultPic.className = 'bg-primary rounded-circle d-flex align-items-center justify-content-center';
        defaultPic.style.width = '40px';
        defaultPic.style.height = '40px';
        const icon = document.createElement('i');
        icon.className = 'bi bi-person-fill text-white';
        defaultPic.appendChild(icon);
        profilePicDiv.appendChild(defaultPic);
      }
      messageDiv.appendChild(profilePicDiv);
    }

    messagesContainer.appendChild(messageDiv);

    // Force scroll to bottom after adding message (only within the container)
    setTimeout(() => {
      console.log('After adding message. ScrollTop:', messagesContainer.scrollTop, 'ScrollHeight:', messagesContainer.scrollHeight);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      console.log('After scroll. New scrollTop:', messagesContainer.scrollTop);

      // Try alternative scrolling method
      const lastMessage = messagesContainer.lastElementChild;
      if (lastMessage) {
        lastMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }, 50);
  }

  // Get the last message ID from the DOM
  function getLastMessageId() {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageDivs = messagesContainer.querySelectorAll('[data-message-id]');
    if (messageDivs.length === 0) return null;
    
    let lastId = 0;
    messageDivs.forEach(div => {
      const id = parseInt(div.getAttribute('data-message-id'));
      if (id > lastId) lastId = id;
    });
    return lastId;
  }

  // Poll for new messages
  function pollForNewMessages() {
    const conversationId = {{ conversation.id }};
    const lastMessageId = getLastMessageId();
    
    let url = `{% url 'store_app:get_new_messages' conversation.id %}`;
    if (lastMessageId) {
      url += `?last_message_id=${lastMessageId}`;
    }

    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.messages && data.messages.length > 0) {
          // Check if user is near bottom of scroll (within 100px)
          const messagesContainer = document.getElementById('messagesContainer');
          const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
          
          // Add new messages
          data.messages.forEach(message => {
            addMessageToConversation(message);
          });
          
          // Auto-scroll if user was near bottom
          if (isNearBottom) {
            setTimeout(() => {
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
          }
        }
      })
      .catch(error => {
        console.error('Error polling for new messages:', error);
      });
  }

  // Handle form submission with AJAX
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageContent');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    let pollingInterval = null;
    let isPageVisible = true;

    // Scroll to bottom on page load
    scrollToBottom();

    // Also try when window is fully loaded
    window.addEventListener('load', scrollToBottom);

    // Add click event to scroll to bottom button
    if (scrollToBottomBtn) {
      scrollToBottomBtn.addEventListener('click', function () {
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
          });
        }
      });
    }

    // Page Visibility API - only poll when page is visible
    document.addEventListener('visibilitychange', function() {
      isPageVisible = !document.hidden;
      if (isPageVisible && pollingInterval === null) {
        // Restart polling if page becomes visible
        startPolling();
      } else if (!isPageVisible && pollingInterval !== null) {
        // Stop polling when page is hidden
        stopPolling();
      }
    });

    // Start polling function
    function startPolling() {
      if (pollingInterval === null) {
        // Poll every 3 seconds
        pollingInterval = setInterval(pollForNewMessages, 3000);
      }
    }

    // Stop polling function
    function stopPolling() {
      if (pollingInterval !== null) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Start polling when page loads (if visible)
    if (isPageVisible) {
      startPolling();
    }

    // Stop polling when user navigates away
    window.addEventListener('beforeunload', stopPolling);

    // Handle product/service selection
    const productServiceSelect = document.getElementById('productServiceSelect');
    const productIdInput = document.getElementById('productIdInput');
    const serviceIdInput = document.getElementById('serviceIdInput');
    
    if (productServiceSelect) {
      productServiceSelect.addEventListener('change', function() {
        const value = this.value;
        if (value.startsWith('product_')) {
          productIdInput.value = value.replace('product_', '');
          serviceIdInput.value = '';
        } else if (value.startsWith('service_')) {
          serviceIdInput.value = value.replace('service_', '');
          productIdInput.value = '';
        } else {
          productIdInput.value = '';
          serviceIdInput.value = '';
        }
      });
    }

    // Handle Enter key to send message (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Prevent new line
        // Trigger form submission
        form.dispatchEvent(new Event('submit', { cancelable: true }));
      }
      // Shift+Enter will naturally create a new line (default behavior)
    });

    form.addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent default form submission

      const messageContent = messageInput.value.trim();
      if (!messageContent) return;

      // Get CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      // Get product/service IDs
      const productId = productIdInput ? productIdInput.value : '';
      const serviceId = serviceIdInput ? serviceIdInput.value : '';
      
      // Build request body
      let body = `content=${encodeURIComponent(messageContent)}`;
      if (productId) {
        body += `&product_id=${encodeURIComponent(productId)}`;
      }
      if (serviceId) {
        body += `&service_id=${encodeURIComponent(serviceId)}`;
      }

      // Send AJAX request
      fetch(window.location.href, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken
        },
        body: body
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Add message to conversation
            addMessageToConversation(data.message);
            // Clear input (but keep product/service selection for next message)
            messageInput.value = '';
            
            // Signal that conversations need to be updated in messages list
            // This will trigger an update if messages.html is open in another tab/window
            localStorage.setItem('conversation_updated', Date.now().toString());
            localStorage.setItem('updated_conversation_id', {{ conversation.id }});
            
            // Dispatch custom event for same-tab updates
            window.dispatchEvent(new Event('conversationUpdated'));
            
            // Also dispatch a storage event for cross-tab updates
            window.dispatchEvent(new Event('storage'));
          } else {
            alert('Error sending message: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error sending message');
        });
    });
  });

</script>
{% endblock %}